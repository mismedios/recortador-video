<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recortador de Videos de Google Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-8 space-y-6">
        
        <!-- Encabezado -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-900">Recortador de Videos de Google Drive</h1>
            <p class="text-gray-600 mt-2">Inicia sesión, selecciona un video de tu Drive, elige los tiempos y guárdalo de nuevo en Drive sin descargarlo.</p>
        </div>

        <!-- Alerta de Configuración -->
        <div id="config-alert" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md" role="alert">
            <p class="font-bold">Acción Requerida</p>
            <p>Esta aplicación requiere una API Key y un Client ID de Google Cloud. Por favor, edita este archivo HTML y reemplaza los valores de `YOUR_API_KEY` y `YOUR_CLIENT_ID` para que funcione.</p>
        </div>

        <!-- Controles Principales -->
        <div class="space-y-4">
            <!-- Botón de Autenticación -->
            <button id="auth-button" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 disabled:bg-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 13.9c0-5.5-3.5-10.9-3.5-10.9s-3.5 5.4-3.5 10.9c0 4.3 2.5 8.1 3.5 8.1s3.5-3.8 3.5-8.1z"></path><path d="M2.5 13.9c0-5.5 3.5-10.9 3.5-10.9s3.5 5.4 3.5 10.9c0 4.3-2.5 8.1-3.5 8.1s-3.5-3.8-3.5-8.1z"></path><path d="M12 22s-4-2-4-8c0-4.5 4-8.5 4-8.5s4 4 4 8.5c0 6-4 8-4 8z"></path></svg>
                <span>Iniciar Sesión y Seleccionar Video</span>
            </button>

            <!-- Información del archivo -->
            <div id="file-info" class="hidden text-center bg-gray-50 p-4 rounded-lg">
                <p class="font-medium">Video Seleccionado:</p>
                <p id="file-name" class="text-gray-700"></p>
            </div>

            <!-- Previsualización y Controles de Recorte -->
            <div id="trim-section" class="hidden space-y-4">
                <video id="video-preview" class="w-full rounded-lg bg-black" controls></video>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-700">Inicio (segundos)</label>
                        <input type="number" id="start-time" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="end-time" class="block text-sm font-medium text-gray-700">Fin (segundos)</label>
                        <input type="number" id="end-time" min="0" value="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>
                <button id="trim-button" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400">
                    Recortar y Guardar en Drive
                </button>
            </div>
            
            <!-- Estado y Resultado -->
            <div id="status-section" class="hidden text-center p-4 bg-indigo-50 rounded-lg space-y-2">
                <div class="flex items-center justify-center gap-3">
                    <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 hidden"></div>
                    <p id="status-message" class="font-medium text-indigo-800"></p>
                </div>
                <a id="result-link" href="#" target="_blank" class="hidden text-blue-600 hover:underline font-semibold">
                    ¡Video recortado con éxito! Haz clic aquí para verlo.
                </a>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <script type="text/javascript">
        // =====================================================================================
        // IMPORTANTE: CONFIGURACIÓN REQUERIDA
        // =====================================================================================
        // 1. Ve a la consola de Google Cloud: https://console.cloud.google.com/
        // 2. Crea un nuevo proyecto.
        // 3. Habilita las APIs "Google Drive API" y "Google Picker API".
        // 4. Ve a "Credenciales", haz clic en "Crear credenciales" y crea una "Clave de API".
        //    Copia y pega esa clave aquí abajo.
        // 5. De nuevo en "Crear credenciales", crea un "ID de cliente de OAuth".
        //    - Tipo de aplicación: "Aplicación web".
        //    - En "Orígenes de JavaScript autorizados", añade la URL donde usarás esta app (ej. http://localhost:8000).
        //    - Copia y pega el "ID de cliente" aquí abajo.
        // =====================================================================================
        const API_KEY = 'AIzaSyAPLzef-btR_O3bEZDsEN9ydu4h-JUwf1EAIzaSyAPLzef-btR_O3bEZDsEN9ydu4h-JUwf1E'; // <-- REEMPLAZA ESTO
        const CLIENT_ID = '494800808739-f172l106nfk6qirjnkuaqma28qcubr3m.apps.googleusercontent.com'; // <-- REEMPLAZA ESTO
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        const authButton = document.getElementById('auth-button');
        const trimSection = document.getElementById('trim-section');
        const fileInfo = document.getElementById('file-info');
        const fileNameEl = document.getElementById('fileName');
        const videoPreview = document.getElementById('video-preview');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const trimButton = document.getElementById('trim-button');
        const statusSection = document.getElementById('status-section');
        const statusMessage = document.getElementById('status-message');
        const resultLink = document.getElementById('result-link');
        const loader = document.getElementById('loader');
        const configAlert = document.getElementById('config-alert');

        let tokenClient;
        let gapiInited = false;
        let gsiInited = false;
        let selectedFile = null;
        let accessToken = null;

        // Verifica si las claves están configuradas
        if (API_KEY === 'YOUR_API_KEY' || CLIENT_ID === 'YOUR_CLIENT_ID') {
            authButton.disabled = true;
        } else {
            configAlert.style.display = 'none';
        }

        // Inicialización de GAPI (Google API) y GSI (Google Sign-In)
        window.onload = () => {
            gapi.load('client:picker', initializeGapiClient);
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleTokenResponse,
            });
            gsiInited = true;
            checkInitState();
        };

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            gapiInited = true;
            checkInitState();
        }
        
        function checkInitState() {
            if (gapiInited && gsiInited) {
                authButton.disabled = (API_KEY === 'YOUR_API_KEY' || CLIENT_ID === 'YOUR_CLIENT_ID');
            }
        }

        authButton.addEventListener('click', () => {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        });

        function handleTokenResponse(resp) {
            if (resp.error) {
                showStatus(`Error: ${resp.error}`, true);
                return;
            }
            accessToken = resp.access_token;
            createPicker();
        }

        function createPicker() {
            const view = new google.picker.View(google.picker.ViewId.VIDEO);
            const picker = new google.picker.PickerBuilder()
                .setAppId(null) // No es necesario si se usa OAuth
                .setOAuthToken(accessToken)
                .setDeveloperKey(API_KEY)
                .addView(view)
                .setCallback(pickerCallback)
                .build();
            picker.setVisible(true);
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                const doc = data.docs[0];
                selectedFile = { id: doc.id, name: doc.name };
                
                document.getElementById('file-name').textContent = selectedFile.name;
                fileInfo.classList.remove('hidden');
                trimSection.classList.remove('hidden');
                authButton.textContent = 'Seleccionar otro video';
                
                showStatus('Obteniendo vista previa del video...', false, true);
                
                try {
                    // Usamos webContentLink para la previsualización, ya que es más rápido
                    const response = await gapi.client.drive.files.get({
                        fileId: selectedFile.id,
                        fields: 'webContentLink, videoMediaMetadata'
                    });
                    
                    const duration = response.result.videoMediaMetadata.durationMillis / 1000;
                    endTimeInput.value = Math.floor(duration);
                    videoPreview.src = response.result.webContentLink;
                    hideStatus();
                } catch (error) {
                    console.error('Error getting file metadata:', error);
                    showStatus('Error al obtener la vista previa. Intenta con otro video.', true);
                }
            }
        }

        // --- Lógica de FFMPEG ---
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({
            log: true,
            corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
        });

        trimButton.addEventListener('click', async () => {
            if (!selectedFile) {
                showStatus('Por favor, selecciona un video primero.', true);
                return;
            }
            trimButton.disabled = true;
            authButton.disabled = true;

            try {
                const startTime = parseFloat(startTimeInput.value);
                const endTime = parseFloat(endTimeInput.value);

                if (isNaN(startTime) || isNaN(endTime) || startTime < 0 || endTime <= startTime) {
                    showStatus('Tiempos de inicio/fin inválidos.', true);
                    return;
                }

                showStatus('Cargando FFMPEG (puede tardar un momento)...', false, true);
                if (!ffmpeg.isLoaded()) {
                    await ffmpeg.load();
                }
                
                showStatus('Descargando el video en el navegador...', false, true);
                const fileResponse = await gapi.client.drive.files.get({
                    fileId: selectedFile.id,
                    alt: 'media'
                });

                showStatus('Escribiendo archivo en memoria...', false, true);
                ffmpeg.FS('writeFile', selectedFile.name, new Uint8Array(fileResponse.body.length));
                ffmpeg.FS('writeFile', selectedFile.name, new Uint8Array(await fileResponse.body.arrayBuffer()));


                showStatus('Recortando el video... Esto puede tardar varios minutos.', false, true);
                // Usamos -c copy para un recorte rápido sin re-codificar
                await ffmpeg.run('-i', selectedFile.name, '-ss', String(startTime), '-to', String(endTime), '-c', 'copy', 'output.mp4');

                showStatus('Lectura del video recortado...', false, true);
                const data = ffmpeg.FS('readFile', 'output.mp4');

                showStatus('Subiendo el nuevo video a Google Drive...', false, true);
                await uploadFile(data);

            } catch (error) {
                console.error(error);
                showStatus('Ocurrió un error durante el proceso.', true);
            } finally {
                trimButton.disabled = false;
                authButton.disabled = false;
            }
        });

        async function uploadFile(fileData) {
            const newFileName = `recortado_${selectedFile.name}`;
            const file = new Blob([fileData.buffer], { type: 'video/mp4' });

            const metadata = {
                'name': newFileName,
                'mimeType': 'video/mp4',
            };
            
            let formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: formData
            });

            const result = await response.json();
            
            if (result.error) {
                showStatus(`Error al subir: ${result.error.message}`, true);
            } else {
                showStatus('¡Video guardado!', false);
                resultLink.href = `https://drive.google.com/file/d/${result.id}/view`;
                resultLink.classList.remove('hidden');
            }
        }

        // --- Funciones de Utilidad para la UI ---
        function showStatus(message, isError = false, showLoader = false) {
            statusSection.classList.remove('hidden');
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'font-medium text-red-700' : 'font-medium text-indigo-800';
            resultLink.classList.add('hidden');
            if (showLoader) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        function hideStatus() {
            statusSection.classList.add('hidden');
        }

    </script>
</body>
</html>
